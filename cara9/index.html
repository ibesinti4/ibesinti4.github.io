!DOCTYPE html>
<html>
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.2/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.11.2/addons/p5.sound.min.js"></script>
</head>
<body>
  <button onclick="changeBackground();">Canvia Fons</button>

  <script>
    let mic;
    let smile = false;
    let bgColor;
    let t = 0;
    let mosquits = [];

    function setup() {
      createCanvas(windowWidth, windowHeight);
      mic = new p5.AudioIn();
      mic.start();
      bgColor = color(200, 220, 255);

      // Crear múltiples mosquitos
      for (let i = 0; i < 10; i++) {
        mosquits.push({
          xOffset: random(1000),
          yOffset: random(1000)
        });
      }
    }

    function draw() {
      t += 0.01;
      let temblar = random(10, 50);
      let sinus = sin(frameCount * 0.1);
      let movsinus = map(sinus, -1, 1, 0, 255);
      let blink = map(sin(frameCount * 0.2), -1, 1, 20, 70); // Parpadeo animado

      let vol = mic.getLevel();
      let h = map(vol, 0, 1, 0, 400);

      background(bgColor);

      // CARA
      fill(217, 190 + h, 150);
      stroke(0);
      ellipse(width / 2, height / 2, 250 + movsinus, 300);

      // BARRET
      fill(0);
      rectMode(CENTER);
      rect(width / 2, height / 2 - 150, 180, 80);
      fill(255, 0, 0);
      rect(width / 2, height / 2 - 110, 250, 20);

      // ULLS que parpadean
      fill(255 + h * 4, 255, 255);
      ellipse(width / 2 - 60, height / 2 - 60, 70, blink); // ull dret
      ellipse(width / 2 + 60, height / 2 - 60, 70, blink); // ull esquerre

      // PUPIL·LES
      fill(1 + h * 4, 1, 1);
      ellipse(width / 2 - 60, height / 2 - 60, 20, 20);
      ellipse(width / 2 + 60, height / 2 - 60, 20, 20);

      // BOCA 
      fill(0);
      noStroke();
      if (smile) {
        arc(width / 2, height / 2 + 90, 100, 90 + h * 6, 0, PI);
      } else {
        arc(width / 2, height / 2 + 110, 100, 90 + h * 6, PI, 0);
      }

      // MOSQUITS
      for (let i = 0; i < mosquits.length; i++) {
        let m = mosquits[i];
        let x = noise(m.xOffset + t) * width;
        let y = noise(m.yOffset + t) * height;

        // Ales
        fill(255);
        ellipse(x + 10, y - 10, 15, 15);
        ellipse(x - 10, y + 10, 15, 15);

        // Cos
        fill(30, 12, 200);
        ellipse(x, y, 30, 20);
      }
    }

    function keyPressed() {
      if (key === 'S' || key === 's') {
        smile = !smile;
      }
    }

    function changeBackground() {
      bgColor = color(random(100, 255), random(100, 255), random(100, 255));
    }
  </script>
</body>
</html>
